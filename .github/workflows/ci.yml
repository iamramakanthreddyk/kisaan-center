name: Continuous Integration

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'

env:
  NODE_VERSION: '20'

jobs:
  backend-validation:
    name: ðŸ” Backend Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ›Žï¸ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: kisaan-backend-node/package-lock.json

    - name: ðŸ“¥ Install dependencies
      working-directory: kisaan-backend-node
      run: npm ci

    - name: ðŸ” TypeScript type checking
      working-directory: kisaan-backend-node
      run: npm run build

    - name: ðŸ§¹ Lint code
      working-directory: kisaan-backend-node
      run: npm run lint

    - name: ðŸ§ª Run unit tests
      working-directory: kisaan-backend-node
      run: npm test
      continue-on-error: true

    - name: ðŸ§ª Run integration tests
      working-directory: kisaan-backend-node
      run: npm run test:integration
      continue-on-error: true

    - name: ðŸ”’ Security audit
      working-directory: kisaan-backend-node
      run: npm audit --audit-level=high
      continue-on-error: true

    - name: ðŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-test-results
        path: kisaan-backend-node/coverage/
        retention-days: 7

  frontend-validation:
    name: ðŸ” Frontend Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ›Žï¸ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: kisaan-frontend/package-lock.json

    - name: ðŸ“¥ Install dependencies
      working-directory: kisaan-frontend
      run: npm install --legacy-peer-deps

    - name: ðŸ” TypeScript type checking
      working-directory: kisaan-frontend
      run: npm run build

    - name: ðŸ§¹ Lint code
      working-directory: kisaan-frontend
      run: npm run lint
      continue-on-error: true

    - name: ðŸ”’ Security audit
      working-directory: kisaan-frontend
      run: npm audit --audit-level=high
      continue-on-error: true

    - name: ðŸ“Š Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: kisaan-frontend/dist/
        retention-days: 7

  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    # The security-scan job needs explicit permission to upload SARIF (code scanning) via the API.
    # Without this, uploads will fail with "Resource not accessible by integration".
    permissions:
      contents: read
      security-events: write
    
    steps:
    - name: ðŸ›Žï¸ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”’ Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ðŸ“¤ Upload Trivy scan results
      # Use the v3 major version of the CodeQL upload action (v1/v2 are deprecated)
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  summary:
    name: ðŸ“‹ CI Summary
    runs-on: ubuntu-latest
    needs: [backend-validation, frontend-validation]
    if: always()
    
    steps:
    - name: ðŸ“‹ Generate summary
      run: |
        echo "## ðŸš€ CI Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Backend Validation | ${{ needs.backend-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend Validation | ${{ needs.frontend-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY